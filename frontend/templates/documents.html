{% extends "base.html" %}

{% block title %}Documents - Intelligent Document Processing{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>
                <i class="fas fa-folder me-2"></i>
                Documents
            </h1>
            <a href="{{ url_for('upload') }}" class="btn btn-primary">
                <i class="fas fa-upload me-2"></i>
                Upload New Document
            </a>
        </div>
    </div>
</div>

<!-- Filters -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label for="statusFilter" class="form-label">Status</label>
                        <select class="form-select" id="statusFilter">
                            <option value="">All Statuses</option>
                            <option value="pending">Pending</option>
                            <option value="processing">Processing</option>
                            <option value="completed">Completed</option>
                            <option value="failed">Failed</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="categoryFilter" class="form-label">Category</label>
                        <select class="form-select" id="categoryFilter">
                            <option value="">All Categories</option>
                            <option value="invoice">Invoice</option>
                            <option value="contract">Contract</option>
                            <option value="resume">Resume</option>
                            <option value="report">Report</option>
                            <option value="legal_document">Legal Document</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="searchInput" class="form-label">Search</label>
                        <input type="text" class="form-control" id="searchInput" placeholder="Search by filename...">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">&nbsp;</label>
                        <div class="d-grid">
                            <button class="btn btn-outline-secondary" onclick="clearFilters()">
                                <i class="fas fa-times me-2"></i>
                                Clear Filters
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Documents Table -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">All Documents</h5>
                <div>
                    <button class="btn btn-sm btn-outline-primary" onclick="loadDocuments()">
                        <i class="fas fa-sync-alt me-1"></i>
                        Refresh
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="documentsContainer">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading documents...</p>
                    </div>
                </div>
                
                <!-- Pagination -->
                <nav aria-label="Documents pagination" id="paginationContainer" style="display: none;">
                    <ul class="pagination justify-content-center mb-0" id="pagination">
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Actions Modal -->
<div class="modal fade" id="bulkActionsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Bulk Actions</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Select an action to perform on <span id="selectedCount">0</span> selected documents:</p>
                <div class="d-grid gap-2">
                    <button class="btn btn-success" onclick="bulkProcess()">
                        <i class="fas fa-play me-2"></i>
                        Process Selected Documents
                    </button>
                    <button class="btn btn-danger" onclick="bulkDelete()">
                        <i class="fas fa-trash me-2"></i>
                        Delete Selected Documents
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentPage = 1;
let totalPages = 1;
let selectedDocuments = new Set();

document.addEventListener('DOMContentLoaded', function() {
    loadDocuments();
    
    // Add event listeners for filters
    document.getElementById('statusFilter').addEventListener('change', loadDocuments);
    document.getElementById('categoryFilter').addEventListener('change', loadDocuments);
    
    // Search with debounce
    let searchTimeout;
    document.getElementById('searchInput').addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(loadDocuments, 500);
    });
});

function loadDocuments(page = 1) {
    currentPage = page;
    const statusFilter = document.getElementById('statusFilter').value;
    const categoryFilter = document.getElementById('categoryFilter').value;
    const searchInput = document.getElementById('searchInput').value;
    
    // Build query parameters
    const params = new URLSearchParams();
    params.append('page', page);
    params.append('per_page', 20);
    
    if (statusFilter) params.append('status', statusFilter);
    if (categoryFilter) params.append('category', categoryFilter);
    if (searchInput) params.append('search', searchInput);
    
    fetch(`/api/documents?${params.toString()}`)
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            showError('Error loading documents: ' + data.error);
            return;
        }
        
        displayDocuments(data.documents);
        updatePagination(data.current_page, data.pages, data.total);
    })
    .catch(error => {
        showError('Error loading documents: ' + error.message);
    });
}

function displayDocuments(documents) {
    const container = document.getElementById('documentsContainer');
    
    if (!documents || documents.length === 0) {
        container.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-folder-open fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">No documents found</h5>
                <p class="text-muted">Try adjusting your filters or upload a new document.</p>
            </div>
        `;
        return;
    }
    
    let html = `
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
                <button class="btn btn-sm btn-outline-primary" onclick="selectAll()">
                    <i class="fas fa-check-square me-1"></i>
                    Select All
                </button>
                <button class="btn btn-sm btn-outline-secondary ms-2" onclick="clearSelection()">
                    <i class="fas fa-square me-1"></i>
                    Clear Selection
                </button>
            </div>
            <div>
                <button class="btn btn-sm btn-primary" onclick="showBulkActions()" id="bulkActionsBtn" style="display: none;">
                    <i class="fas fa-cogs me-1"></i>
                    Bulk Actions (<span id="selectionCount">0</span>)
                </button>
            </div>
        </div>
        
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th width="50">
                            <input type="checkbox" class="form-check-input" id="selectAllCheckbox" onchange="toggleSelectAll()">
                        </th>
                        <th>Filename</th>
                        <th>Type</th>
                        <th>Size</th>
                        <th>Category</th>
                        <th>Department</th>
                        <th>Status</th>
                        <th>Upload Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    documents.forEach(doc => {
        const uploadDate = doc.upload_date ? new Date(doc.upload_date).toLocaleDateString() : 'N/A';
        const fileSize = formatFileSize(doc.file_size || 0);
        const fileType = doc.file_type ? doc.file_type.split('/').pop() : 'unknown';
        
        html += `
            <tr>
                <td>
                    <input type="checkbox" class="form-check-input document-checkbox" 
                           value="${doc.id}" onchange="toggleDocumentSelection(${doc.id})">
                </td>
                <td>
                    <div class="d-flex align-items-center">
                        <i class="fas fa-file me-2 text-muted"></i>
                        <div>
                            <div class="fw-medium">${doc.original_filename}</div>
                            ${doc.summary ? `<small class="text-muted">${doc.summary.substring(0, 100)}...</small>` : ''}
                        </div>
                    </div>
                </td>
                <td>
                    <span class="badge bg-secondary">${fileType}</span>
                </td>
                <td>${fileSize}</td>
                <td>
                    ${doc.document_type ? 
                        `<span class="badge bg-info">${doc.document_type}</span>` : 
                        '<span class="text-muted">Not classified</span>'
                    }
                    ${doc.confidence_score ? 
                        `<br><small class="text-muted">${(doc.confidence_score * 100).toFixed(1)}% confidence</small>` : 
                        ''
                    }
                </td>
                <td>
                    ${doc.department ? 
                        `<span class="badge bg-primary">${doc.department}</span>` : 
                        '<span class="text-muted">Not routed</span>'
                    }
                </td>
                <td>${getStatusBadge(doc.status)}</td>
                <td>${uploadDate}</td>
                <td>
                    <div class="btn-group btn-group-sm" role="group">
                        <a href="/document/${doc.id}" class="btn btn-outline-primary">
                            <i class="fas fa-eye"></i>
                        </a>
                        ${doc.status === 'failed' ? 
                            `<button class="btn btn-outline-warning" onclick="processDocument(${doc.id})">
                                <i class="fas fa-sync-alt"></i>
                            </button>` : 
                            ''
                        }
                        <button class="btn btn-outline-danger" onclick="deleteDocument(${doc.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    });
    
    html += `
                </tbody>
            </table>
        </div>
    `;
    
    container.innerHTML = html;
}

function updatePagination(currentPage, totalPages, totalDocuments) {
    const paginationContainer = document.getElementById('paginationContainer');
    const pagination = document.getElementById('pagination');
    
    if (totalPages <= 1) {
        paginationContainer.style.display = 'none';
        return;
    }
    
    paginationContainer.style.display = 'block';
    
    let html = '';
    
    // Previous button
    html += `
        <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="loadDocuments(${currentPage - 1})">Previous</a>
        </li>
    `;
    
    // Page numbers
    for (let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) {
        html += `
            <li class="page-item ${i === currentPage ? 'active' : ''}">
                <a class="page-link" href="#" onclick="loadDocuments(${i})">${i}</a>
            </li>
        `;
    }
    
    // Next button
    html += `
        <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="loadDocuments(${currentPage + 1})">Next</a>
        </li>
    `;
    
    pagination.innerHTML = html;
}

function getStatusBadge(status) {
    const badges = {
        'completed': '<span class="badge bg-success"><i class="fas fa-check me-1"></i>Completed</span>',
        'processing': '<span class="badge bg-warning"><i class="fas fa-spinner fa-spin me-1"></i>Processing</span>',
        'pending': '<span class="badge bg-secondary"><i class="fas fa-clock me-1"></i>Pending</span>',
        'failed': '<span class="badge bg-danger"><i class="fas fa-times me-1"></i>Failed</span>'
    };
    
    return badges[status] || '<span class="badge bg-secondary">Unknown</span>';
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function clearFilters() {
    document.getElementById('statusFilter').value = '';
    document.getElementById('categoryFilter').value = '';
    document.getElementById('searchInput').value = '';
    loadDocuments();
}

function toggleDocumentSelection(docId) {
    if (selectedDocuments.has(docId)) {
        selectedDocuments.delete(docId);
    } else {
        selectedDocuments.add(docId);
    }
    updateSelectionUI();
}

function toggleSelectAll() {
    const checkbox = document.getElementById('selectAllCheckbox');
    const documentCheckboxes = document.querySelectorAll('.document-checkbox');
    
    if (checkbox.checked) {
        documentCheckboxes.forEach(cb => {
            cb.checked = true;
            selectedDocuments.add(parseInt(cb.value));
        });
    } else {
        documentCheckboxes.forEach(cb => {
            cb.checked = false;
            selectedDocuments.delete(parseInt(cb.value));
        });
    }
    updateSelectionUI();
}

function selectAll() {
    document.getElementById('selectAllCheckbox').checked = true;
    toggleSelectAll();
}

function clearSelection() {
    document.getElementById('selectAllCheckbox').checked = false;
    toggleSelectAll();
}

function updateSelectionUI() {
    const count = selectedDocuments.size;
    const bulkActionsBtn = document.getElementById('bulkActionsBtn');
    const selectionCount = document.getElementById('selectionCount');
    
    if (count > 0) {
        bulkActionsBtn.style.display = 'inline-block';
        selectionCount.textContent = count;
    } else {
        bulkActionsBtn.style.display = 'none';
    }
}

function showBulkActions() {
    document.getElementById('selectedCount').textContent = selectedDocuments.size;
    const modal = new bootstrap.Modal(document.getElementById('bulkActionsModal'));
    modal.show();
}

function processDocument(docId) {
    fetch(`/api/process/${docId}`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Document processing started successfully!', 'success');
            loadDocuments(currentPage);
        } else {
            showAlert(`Error processing document: ${data.error}`, 'danger');
        }
    })
    .catch(error => {
        showAlert(`Error processing document: ${error.message}`, 'danger');
    });
}

function deleteDocument(docId) {
    if (!confirm('Are you sure you want to delete this document? This action cannot be undone.')) {
        return;
    }
    
    fetch(`/api/document/${docId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Document deleted successfully!', 'success');
            // Remove from selected documents if it was selected
            selectedDocuments.delete(docId.toString());
            // Reload the documents list
            loadDocuments();
        } else {
            showAlert(`Error deleting document: ${data.error}`, 'danger');
        }
    })
    .catch(error => {
        showAlert(`Error deleting document: ${error.message}`, 'danger');
    });
}

function bulkProcess() {
    if (selectedDocuments.size === 0) {
        showAlert('No documents selected.', 'warning');
        return;
    }
    
    // Show processing modal
    const processingModal = new bootstrap.Modal(document.getElementById('processingModal'));
    processingModal.show();
    
    // Convert Set to Array
    const docIds = Array.from(selectedDocuments);
    let processed = 0;
    let errors = 0;
    
    // Process each document sequentially
    const processNext = (index) => {
        if (index >= docIds.length) {
            // All documents processed
            processingModal.hide();
            
            if (errors > 0) {
                showAlert(`Processing complete: ${processed} documents processed, ${errors} errors.`, 'warning');
            } else {
                showAlert(`Successfully processed ${processed} documents.`, 'success');
            }
            
            // Reload the document list
            setTimeout(() => {
                loadDocuments(currentPage);
            }, 2000);
            
            return;
        }
        
        // Process current document
        const docId = docIds[index];
        
        fetch(`/api/process/${docId}`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                processed++;
            } else {
                errors++;
                console.error(`Error processing document ${docId}:`, data.error);
            }
            
            // Process next document
            processNext(index + 1);
        })
        .catch(error => {
            errors++;
            console.error(`Error processing document ${docId}:`, error);
            
            // Process next document
            processNext(index + 1);
        });
    };
    
    // Start processing
    processNext(0);
}

function bulkDelete() {
    if (selectedDocuments.size === 0) {
        showAlert('No documents selected.', 'warning');
        return;
    }
    
    const count = selectedDocuments.size;
    if (!confirm(`Are you sure you want to delete ${count} document${count > 1 ? 's' : ''}? This action cannot be undone.`)) {
        return;
    }
    
    const docIds = Array.from(selectedDocuments);
    let completed = 0;
    let successful = 0;
    let failed = 0;
    
    // Process each document deletion
    docIds.forEach(docId => {
        fetch(`/api/document/${docId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            completed++;
            if (data.success) {
                successful++;
            } else {
                failed++;
            }
            
            // When all deletions are complete
            if (completed === docIds.length) {
                if (failed === 0) {
                    showAlert(`${successful} document${successful > 1 ? 's' : ''} deleted successfully!`, 'success');
                } else {
                    showAlert(`${successful} document${successful > 1 ? 's' : ''} deleted successfully, ${failed} failed.`, 'warning');
                }
                
                // Clear selection and reload
                selectedDocuments.clear();
                document.getElementById('selectAllCheckbox').checked = false;
                loadDocuments();
            }
        })
        .catch(error => {
            completed++;
            failed++;
            
            if (completed === docIds.length) {
                showAlert(`${successful} document${successful > 1 ? 's' : ''} deleted successfully, ${failed} failed.`, 'warning');
                selectedDocuments.clear();
                document.getElementById('selectAllCheckbox').checked = false;
                loadDocuments();
            }
        });
    });
}

function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    const container = document.querySelector('main');
    if (container) {
        container.insertBefore(alertDiv, container.firstChild);
        
        setTimeout(() => {
            alertDiv.remove();
        }, 5000);
    } else {
        console.error('Main container not found for alert:', message);
    }
}

function showError(message) {
    document.getElementById('documentsContainer').innerHTML = `
        <div class="text-center py-4">
            <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
            <h5 class="text-danger">Error Loading Documents</h5>
            <p class="text-muted">${message}</p>
            <button class="btn btn-outline-primary" onclick="loadDocuments()">
                <i class="fas fa-sync-alt me-2"></i>
                Try Again
            </button>
        </div>
    `;
}
</script>

<!-- Processing Modal -->
<div class="modal fade" id="processingModal" tabindex="-1" aria-labelledby="processingModalLabel" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="processingModalLabel">Processing Documents</h5>
            </div>
            <div class="modal-body text-center py-4">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mb-0">Please wait while we process your documents...</p>
                <p class="text-muted small mt-2">This may take a few moments.</p>
            </div>
        </div>
    </div>
</div>

<script src="{{ url_for('static', filename='js/documents.js') }}"></script>
{% endblock %}